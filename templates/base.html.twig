<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Hygieconnect{% endblock %}</title>

    <!-- Core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    {% block stylesheets %}
        <link rel="stylesheet" href="{{ asset('css/stylebase.css') }}">
    {% endblock %}

    <style>
    /* --- Chat IA flottant global --- */
    #chat-toggle {
        position: fixed;
        bottom: 25px;
        right: 25px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #007bff, #00bcd4);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 26px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        cursor: pointer;
        z-index: 1001;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    #chat-toggle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }

    #chat-container {
        position: fixed;
        bottom: 100px;
        right: 25px;
        width: 350px;
        height: 450px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        border-radius: 18px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        display: none;
        flex-direction: column;
        overflow: hidden;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    #chat-header {
        background: linear-gradient(135deg, #007bff, #00bcd4);
        color: white;
        padding: 10px 15px;
        text-align: center;
        font-weight: bold;
        font-size: 16px;
    }

    #chat-box {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        background: rgba(255,255,255,0.7);
    }

    .chat-message {
        margin-bottom: 10px;
        line-height: 1.4;
    }

    .chat-user {
        font-weight: bold;
        color: #007bff;
    }

    .chat-ia {
        font-weight: bold;
        color: #00bcd4;
    }

    #chat-input-area {
        display: flex;
        padding: 8px;
        border-top: 1px solid #ddd;
        background: rgba(255,255,255,0.85);
    }

    #chat-input {
        flex: 1;
        border: none;
        padding: 8px;
        border-radius: 8px;
        outline: none;
    }

    #chat-send {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 12px;
        margin-left: 6px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
    }

    #chat-send:hover {
        background: #0056b3;
    }

    /* Responsive */
    @media (max-width: 768px) {
        #chat-container {
            width: 90%;
            right: 5%;
            height: 400px;
        }
    }
    </style>
</head>

<body>
    {{ include('components/navbar.html.twig') }}

    <div class="container-fluid mt-4">
        <!-- Messages Flash -->
        {% for type, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ type }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
                </div>
            {% endfor %}
        {% endfor %}

        {% block body %}{% endblock %}
    </div>

    <!-- Chat IA Global -->
    <div id="chat-toggle"><i class="fas fa-comment-dots"></i></div>
    <div id="chat-container">
        <div id="chat-header">üí¨ HygieConnect IA</div>
        <div id="chat-box"></div>
        <div id="chat-input-area">
            <input id="chat-input" type="text" placeholder="Pose ta question...">
            <button id="chat-send">Envoyer</button>
        </div>
    </div>

    {{ include('components/footer.html.twig') }}

    {% block javascripts %}
        <script src="https://kit.fontawesome.com/2c09a0622a.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>

<script>
const chatToggle = document.getElementById('chat-toggle');
const chatContainer = document.getElementById('chat-container');
const chatBox = document.getElementById('chat-box');
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');

chatToggle.addEventListener('click', () => {
    chatContainer.style.display = chatContainer.style.display === 'flex' ? 'none' : 'flex';
});

chatSend.addEventListener('click', sendMessage);
chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    // Afficher le message utilisateur
    chatBox.innerHTML += `<div class="chat-message"><span class="chat-user">Toi :</span> ${message}</div>`;
    chatInput.value = '';
    chatBox.scrollTop = chatBox.scrollHeight;

    // Afficher "IA en train d'√©crire"
    const typingElem = document.createElement('div');
    typingElem.classList.add('chat-message');
    typingElem.innerHTML = '<span class="chat-ia">IA :</span> <span class="typing">...</span>';
    chatBox.appendChild(typingElem);
    chatBox.scrollTop = chatBox.scrollHeight;

    try {
        const res = await fetch('/ask', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message})
        });

        const data = await res.json();

        // Supprimer l‚Äôeffet de typing
        typingElem.remove();

        if (data.response) {
            // Affichage r√©ponse IA avec petit d√©lai caract√®re par caract√®re
            const responseText = data.response;
            const iaElem = document.createElement('div');
            iaElem.classList.add('chat-message');
            iaElem.innerHTML = '<span class="chat-ia">IA :</span> ';
            chatBox.appendChild(iaElem);

            let i = 0;
            function typeWriter() {
                if (i < responseText.length) {
                    iaElem.innerHTML += responseText.charAt(i);
                    i++;
                    chatBox.scrollTop = chatBox.scrollHeight;
                    setTimeout(typeWriter, 20); // vitesse de frappe (ms)
                }
            }
            typeWriter();
        } else {
            chatBox.innerHTML += `<div class="chat-message text-danger">Erreur : ${data.error || 'Inconnue'}</div>`;
        }
    } catch (error) {
        typingElem.remove();
        chatBox.innerHTML += `<div class="chat-message text-danger">Erreur de connexion au serveur</div>`;
    }
    chatBox.scrollTop = chatBox.scrollHeight;
}
</script>

    {% endblock %}
</body>
</html>
